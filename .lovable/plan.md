
# تنفيذ نظام تسجيل الدخول والصلاحيات

## ملخص
سيتم إنشاء نظام تسجيل دخول كامل باللغة العربية مع ثلاثة أدوار (مدير، محاسب، موظف مبيعات) وحماية جميع الصفحات بحيث لا يمكن الوصول إليها إلا بعد تسجيل الدخول.

---

## المرحلة 1: إنشاء قاعدة البيانات

### جداول جديدة:

**1. جدول الملفات الشخصية (profiles)**
- id (مرتبط بالمستخدم)
- full_name (الاسم الكامل)
- created_at

**2. جدول الأدوار (user_roles)**
- id
- user_id (مرتبط بالمستخدم)
- role (نوع الدور: admin / accountant / sales)

### دوال قاعدة البيانات:
- دالة `has_role` للتحقق من صلاحية المستخدم (Security Definer لتجنب مشاكل RLS)
- دالة `get_user_role` لجلب دور المستخدم
- محفز (Trigger) لإنشاء ملف شخصي تلقائيا عند التسجيل، مع منح أول مستخدم دور "مدير"

### سياسات الأمان (RLS):
- المستخدم يرى ملفه الشخصي فقط، والمدير يرى الجميع
- المدير فقط يمكنه تعديل الأدوار

---

## المرحلة 2: صفحات المصادقة

### صفحة تسجيل الدخول (Auth.tsx)
- نموذج بريد إلكتروني وكلمة مرور
- تبديل بين تسجيل الدخول وإنشاء حساب جديد
- تصميم عربي كامل RTL
- توجيه تلقائي للوحة التحكم بعد تسجيل الدخول

---

## المرحلة 3: حماية التطبيق

### مكونات جديدة:
- **AuthProvider**: سياق (Context) لإدارة حالة المستخدم والدور
- **ProtectedRoute**: مكون لحماية الصفحات ومنع الوصول بدون تسجيل دخول
- **RoleGuard**: مكون لإخفاء عناصر حسب الدور

### صلاحيات الأدوار:
| الصفحة | مدير | محاسب | موظف مبيعات |
|--------|------|-------|-------------|
| لوحة التحكم | نعم | نعم | نعم |
| شجرة الحسابات | نعم | نعم | لا |
| القيود المحاسبية | نعم | نعم | لا |
| دفتر الأستاذ | نعم | نعم | لا |
| المبيعات | نعم | نعم | نعم |
| العملاء | نعم | نعم | نعم |
| المشتريات | نعم | نعم | لا |
| الموردين | نعم | نعم | لا |
| المنتجات | نعم | نعم | نعم |
| التقارير | نعم | نعم | لا |
| الإعدادات | نعم | لا | لا |

---

## المرحلة 4: تحديث الواجهة

- إضافة زر تسجيل الخروج في الشريط العلوي مع اسم المستخدم ودوره
- إخفاء عناصر القائمة الجانبية حسب صلاحيات الدور
- إضافة مسار `/auth` في التوجيه

---

## التفاصيل التقنية

### هيكل الملفات الجديدة:
```text
src/
  contexts/
    AuthContext.tsx          -- سياق المصادقة والصلاحيات
  components/
    auth/
      ProtectedRoute.tsx     -- حماية المسارات
      RoleGuard.tsx          -- حماية حسب الدور
  pages/
    Auth.tsx                 -- صفحة تسجيل الدخول
```

### SQL Migration:
```text
1. إنشاء enum: app_role (admin, accountant, sales)
2. إنشاء جدول profiles مع RLS
3. إنشاء جدول user_roles مع RLS
4. إنشاء دالة has_role (security definer)
5. إنشاء trigger لإنشاء ملف تلقائي عند التسجيل
```
